<style>
    :root {
        --p-primary: #C4A092;
        /* Terracotta */
        --p-bg: #F1ECE5;
        /* Soft Taupe */
        --p-white: #FEFBF6;
        /* Cream (Surface) */
        --p-border: #CFC3C3;
        /* Stone */
        --p-text: #000000;
        /* Black */
        --p-text-subdued: #82736C;
        /* Truffle */
        --p-accent: #BB7A7E;
        /* Mauve */
        --p-success: #485B59;
        /* Forest */
    }

    #fabric-scanner-root {
        padding-bottom: 50px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #fabric-scanner-root.fb-ready {
        opacity: 1;
    }

    .fb-header {
        background: var(--p-white);
        padding: 10px 20px;
        display: none;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--p-border);
    }

    .fb-user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .fb-badge {
        background: var(--p-white);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        color: var(--p-text-subdued);
        border: 1px solid var(--p-border);
    }

    .fb-logout-btn {
        background: none;
        border: none;
        color: #d32f2f;
        cursor: pointer;
        padding: 5px;
    }

    .fb-tabs {
        display: flex;
        background: var(--p-white);
        border-bottom: 1px solid var(--p-border);
    }

    .fb-tab-btn {
        flex: 1;
        padding: 18px 10px;
        border: none;
        background: none;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 11px;
        cursor: pointer;
        color: var(--p-text-subdued);
        transition: all 0.2s;
    }

    .fb-tab-btn.active {
        color: var(--p-primary);
        border-bottom: 3px solid var(--p-primary);
    }

    .fb-pane {
        display: none;
        padding: 15px;
    }

    .fb-pane.active {
        display: block;
    }

    /* Orders styling */
    .fb-order-card {
        background: var(--p-white);
        border: 1px solid var(--p-border);
        margin-bottom: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        overflow: hidden;
    }

    .fb-order-row {
        display: flex;
        padding: 10px;
        border-bottom: 1px solid #eee;
        align-items: center;
        gap: 15px;
    }

    .fb-order-header {
        padding: 15px 20px;
        background: var(--p-white);
        font-weight: 700;
        border-bottom: 1px solid var(--p-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
    }

    .fb-order-header:hover {
        background: #faf7f4;
    }

    .fb-order-items {
        display: none;
    }

    .fb-chevron {
        transition: transform 0.2s;
        width: 20px;
        height: 20px;
    }

    .fb-chevron.open {
        transform: rotate(180deg);
    }

    /* Stock card styling */
    .fb-stock-card {
        background: var(--p-white);
        border: 1px solid var(--p-border);
        margin-bottom: 20px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .fb-stock-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
    }

    .fb-stock-body {
        display: flex;
        padding: 15px;
        gap: 15px;
        align-items: center;
    }

    .fb-stock-img {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid var(--p-border);
        flex-shrink: 0;
    }

    .fb-stock-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .fb-stock-title {
        font-weight: 800;
        font-size: 15px;
        color: var(--p-text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .fb-stock-sku {
        font-size: 11px;
        font-weight: 600;
        color: var(--p-text-subdued);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .fb-stock-qty {
        font-size: 12px;
        font-weight: 700;
        color: var(--p-primary);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .fb-stock-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px dashed var(--p-border);
    }

    .fb-stock-bin {
        font-size: 11px;
        font-weight: 800;
        color: var(--p-text-subdued);
        background: rgba(130, 115, 108, 0.1);
        padding: 2px 8px;
        border-radius: 4px;
    }

    .fb-item-info {
        font-size: 12px;
        color: var(--p-text-subdued);
        line-height: 1.4;
    }

    .fb-item-info .fb-status {
        color: #27ae60 !important;
        font-weight: bold;
    }

    .fb-item-info .fb-status::before {
        content: " | ";
    }

    @media (max-width: 600px) {
        .fb-item-info .fb-status {
            display: block;
            margin-top: 2px;
        }

        .fb-item-info .fb-status::before {
            content: "";
        }
    }

    .fb-btn {
        background: var(--p-primary);
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .fb-btn:hover {
        background: #b59285;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .fb-btn:disabled {
        background: var(--p-border);
        color: var(--p-text-subdued);
        cursor: not-allowed;
    }

    .fb-btn-secondary {
        background: var(--p-text-subdued);
    }

    .fb-btn-secondary:hover {
        background: #6b5e58;
    }

    .fb-btn-success {
        background: var(--p-success);
    }

    .fb-btn-success:hover {
        background: #3e4f4d;
    }

    .fb-input {
        width: 100%;
        padding: 12px 15px;
        margin: 12px 0;
        border: 1px solid var(--p-border);
        border-radius: 8px;
        background: var(--p-white);
        box-sizing: border-box;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .fb-input:focus {
        border-color: var(--p-primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(196, 160, 146, 0.1);
    }

    #fb-loader {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(241, 236, 229, 0.85);
        /* Brand Taupe with transparency */
        z-index: 100000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .premium-loader {
        position: relative;
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .premium-loader::after,
    .premium-loader::before {
        content: "";
        position: absolute;
        width: 60px;
        height: 60px;
        border: 3px solid var(--p-primary);
        border-radius: 50%;
        animation: fb-pulse 1.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }

    .premium-loader::after {
        animation-delay: -0.9s;
    }

    @keyframes fb-pulse {
        0% {
            transform: scale(0);
            opacity: 1;
        }

        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }

    .fb-pagination-box {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
    }

    .btn-pagination {
        background: var(--p-white);
        border: 1px solid var(--p-border);
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        color: var(--p-text);
        transition: all 0.2s;
    }

    .btn-pagination:hover {
        background: #faf7f4;
        border-color: var(--p-text-subdued);
    }

    /* Scanner Enhancements */
    #scanner-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        border: 2px solid #555;
        border-radius: 8px;
        overflow: hidden;
        background: #000;
    }

    #reader {
        width: 100% !important;
        border: none !important;
    }

    #reader video {
        width: 100% !important;
        height: auto !important;
        object-fit: cover;
    }

    .scan-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    }

    .scan-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: var(--p-accent);
        box-shadow: 0 0 15px var(--p-accent);
        top: 0;
        animation: fb-scanAnim 2s linear infinite;
    }

    @keyframes fb-scanAnim {
        0% {
            top: 0%;
        }

        50% {
            top: 100%;
        }

        100% {
            top: 0%;
        }
    }

    .scan-corner {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 4px solid var(--p-accent);
    }

    .corner-tl {
        top: 10px;
        left: 10px;
        border-right: 0;
        border-bottom: 0;
    }

    .corner-tr {
        top: 10px;
        right: 10px;
        border-left: 0;
        border-bottom: 0;
    }

    .corner-bl {
        bottom: 10px;
        left: 10px;
        border-right: 0;
        border-top: 0;
    }

    .corner-br {
        bottom: 10px;
        right: 10px;
        border-left: 0;
        border-top: 0;
    }

    #auth-section {
        display: -webkit-box !important;
        display: -ms-flexbox !important;
        display: flex !important;
        -webkit-box-pack: center !important;
        -ms-flex-pack: center !important;
        justify-content: center !important;
        -webkit-box-align: center !important;
        -ms-flex-align: center !important;
        align-items: center !important;
        min-height: 500px;
        width: 100%;
        margin: 0 auto;
        padding: 40px 20px;
        box-sizing: border-box;
    }

    .fb-auth-box {
        max-width: 400px;
        width: 100%;
        background: var(--p-white);
        padding: 40px;
        border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
        text-align: center;
        border: 1px solid var(--p-border);
        animation: fb-slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1) both;
    }

    @keyframes fb-slideUp {
        0% {
            transform: translateY(30px);
            opacity: 0;
        }

        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .fb-pass-wrapper {
        position: relative;
        margin: 12px 0;
    }

    .fb-toggle-pass {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: var(--p-text-subdued);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
        transition: color 0.2s;
    }

    .fb-toggle-pass:hover {
        color: var(--p-primary);
    }
</style>

<div id="fabric-scanner-root">
    <div id="fb-loader">
        <div class="premium-loader">&nbsp;</div>
        <div
            style="margin-top:40px; font-weight:800; letter-spacing:3px; font-size:11px; color:var(--p-primary); text-transform:uppercase;">
            Refreshing</div>
    </div>
    <header class="fb-header" id="main-nav">
        <div style="font-weight: 800; letter-spacing: 2px; font-size: 14px; color: var(--p-text-subdued);">FABRIC
            SCANNER</div>
        <div class="fb-user-info">
            <div class="fb-badge" id="user-display-name">Guest</div>
            <button class="fb-logout-btn" id="logout-trigger" style="display:none;">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M12 2v2H4v12h8v2H2V2h10zm7 8l-4 4v-3H9V9h6V6l4 4z" />
                </svg>
            </button>
        </div>
    </header>

    <div id="auth-section">
        <div class="fb-auth-box">
            <h2 style="margin-top: 0; font-weight: 800; letter-spacing: -0.5px; color: var(--p-text-subdued);">Welcome
                Back</h2>
            <div style="margin-bottom: 25px; font-size: 14px; color: var(--p-text-subdued);">Please sign in to continue
            </div>

            <input type="text" id="staff-id" placeholder="Username / Email" class="fb-input"
                style="margin-bottom: 5px;">

            <div class="fb-pass-wrapper">
                <input type="password" id="staff-pass" placeholder="PIN" class="fb-input" style="margin: 0;">
                <div class="fb-toggle-pass" id="toggle-pass-btn">
                    <svg id="eye-open" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 9-8 9 8 9 8-4 8-9 8-9-8-9-8z"></path>
                        <circle cx="10" cy="12" r="3"></circle>
                    </svg>
                    <svg id="eye-closed" style="display:none;" width="20" height="20" viewBox="0 0 20 20" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M17.94 17.94A10.07 10.07 0 0 1 10 20c-5 0-9-8-9-8a11.54 11.54 0 0 1 2.51-4.06M8.47 8.47a3 3 0 0 0 4.06 4.06M1 1l18 18">
                        </path>
                    </svg>
                </div>
            </div>

            <button id="login-btn" class="fb-btn"
                style="width: 100%; margin-top: 20px; height: 50px; font-size: 16px;">Sign In</button>
            <button id="clear-session-btn" class="fb-btn"
                style="width: 100%; margin-top: 10px; background: #d32f2f; display: none;">Clear Old Session</button>

            <div id="session-warning"
                style="display: none; margin-top: 20px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; font-size: 13px; color: #856404;">
                ⚠️ You have an old session from a previous app. Click "Clear Old Session" to log in with new
                credentials.
            </div>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <div class="fb-tabs">
            <button class="fb-tab-btn active" id="tab-stock" data-tab="stock-pane" style="display:none;">Stock</button>
            <button class="fb-tab-btn" id="tab-orders" data-tab="orders-pane" style="display:none;">Orders</button>
            <button class="fb-tab-btn" id="tab-history" data-tab="history-pane" style="display:none;">History</button>
        </div>

        <div id="stock-pane" class="fb-pane active">
            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <input type="text" id="inv-search-input" placeholder="Search title, SKU, BIN..." class="fb-input"
                    style="margin:0; flex:1; height: 38px; padding: 0 15px; border-radius: 8px;">
                <select id="inv-sort-select" class="fb-input"
                    style="margin:0; width: 110px; font-size: 13px; height: 38px; padding: 0 5px; border-radius: 8px;">
                    <option value="CREATED_AT:true">Newest</option>
                    <option value="CREATED_AT:false">Oldest</option>
                    <option value="TITLE:false">A-Z</option>
                    <option value="TITLE:true">Z-A</option>
                    <option value="INVENTORY_TOTAL:false">Low Stock</option>
                    <option value="INVENTORY_TOTAL:true">High Stock</option>
                </select>
            </div>
            <div id="inventory-list"></div>
            <div class="fb-pagination-box" id="stock-pagination" style="display:none;">
                <button id="prev-inventory" class="btn-pagination">Prev</button>
                <span id="page-label-inventory">Page 1</span>
                <button id="next-inventory" class="btn-pagination">Next</button>
            </div>
        </div>

        <div id="orders-pane" class="fb-pane">
            <div id="order-container"></div>
            <div class="fb-pagination-box" id="orders-pagination" style="display:none;">
                <button id="prev-orders" class="btn-pagination">Prev</button>
                <span id="page-label-orders">Page 1</span>
                <button id="next-orders" class="btn-pagination">Next</button>
            </div>
        </div>

        <div id="history-pane" class="fb-pane">
            <div id="history-container"></div>
            <div class="fb-pagination-box" id="history-pagination" style="display:none;">
                <button id="prev-history" class="btn-pagination">Prev</button>
                <span id="page-label-history">Page 1</span>
                <button id="next-history" class="btn-pagination">Next</button>
            </div>
        </div>
    </div>
</div>

<div id="camera-modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; flex-direction:column; align-items:center; justify-content:center;">
    <div style="color:white; font-size:18px; font-weight:bold; margin-bottom:10px; text-align:center; padding: 0 20px;">
        SCANNING: <span id="scan-target-name" style="color:#00ff00;">--</span>
    </div>
    <div id="scan-target-sku" style="color:#bdc3c7; font-size:14px; margin-bottom:15px;">SKU: --</div>
    <div
        style="background:#222; color:#fff; padding:10px 20px; border-radius:30px; margin-bottom:20px; font-weight:bold; font-size:16px;">
        Scan on <span id="scan-target-bin" style="color:#f1c40f;">BIN #--</span>
    </div>

    <div id="scanner-container">
        <div id="reader"></div>
        <div class="scan-overlay">
            <div class="scan-line">&nbsp;</div>
            <div class="scan-corner corner-tl">&nbsp;</div>
            <div class="scan-corner corner-tr">&nbsp;</div>
            <div class="scan-corner corner-bl">&nbsp;</div>
            <div class="scan-corner corner-br">&nbsp;</div>
        </div>
    </div>

    <div style="margin-top:20px;">
        <button id="scanner-cancel-btn" class="fb-btn"
            style="background:#d32f2f; padding: 12px 30px; font-size: 16px;">CANCEL SCAN</button>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>

<script>
    (function () {
        const STORAGE_KEY_VERIFIED = 'fb_verified_items_stable';
        const STORAGE_KEY_PRINTED = 'fb_printed_labels_stable';
        const PROXY_URL = '/apps/fabric-scanner/get';

        let verifiedItems = new Set(), printedLabels = new Set(), inventoryData = [], ordersData = [], historyData = [];
        let html5QrCode = null, currentUser = null, isScanning = false;

        let invPage = 1, invHasPrev = false, invHasNext = false, invStart = null, invEnd = null;
        let invSort = 'CREATED_AT', invReverse = true;
        let ordPage = 1, ordHasPrev = false, ordHasNext = false, ordStart = null, ordEnd = null;
        let histPage = 1, histHasPrev = false, histHasNext = false, histStart = null, histEnd = null;

        const setLoader = (show) => document.getElementById('fb-loader').style.display = show ? 'flex' : 'none';

        const loadState = () => {
            try {
                const v = localStorage.getItem(STORAGE_KEY_VERIFIED);
                if (v) verifiedItems = new Set(JSON.parse(v));
                const p = localStorage.getItem(STORAGE_KEY_PRINTED);
                if (p) printedLabels = new Set(JSON.parse(p));
            } catch (e) { console.error("Error loading state", e); }
        };

        const saveState = () => {
            try {
                localStorage.setItem(STORAGE_KEY_VERIFIED, JSON.stringify([...verifiedItems]));
                localStorage.setItem(STORAGE_KEY_PRINTED, JSON.stringify([...printedLabels]));
            } catch (e) { console.error("Error saving state", e); }
        };

        const getBin = (node) => {
            if (!node || !node.metafields) return 'N/A';
            const m = node.metafields.edges.find(x => x.node.key === 'bin_number');
            return m ? m.node.value : 'N/A';
        }

        window.toggleOrder = (header) => {
            const items = header.nextElementSibling;
            const chevron = header.querySelector('.fb-chevron');
            const isHidden = items.style.display === 'none' || (items.style.display === '' && window.getComputedStyle(items).display === 'none');

            if (isHidden) {
                items.style.display = 'block';
                chevron.classList.add('open');
            } else {
                items.style.display = 'none';
                chevron.classList.remove('open');
            }
        }

        const updateUIVisibility = () => {
            if (!currentUser) return;
            console.log('[UI] Updating visibility based on settings:', currentUser);
            const stockTab = document.getElementById('tab-stock');
            const ordersTab = document.getElementById('tab-orders');
            const historyTab = document.getElementById('tab-history');
            if (currentUser.showStockTab !== false) stockTab.style.display = 'block'; else stockTab.style.display = 'none';
            if (currentUser.showOrdersTab !== false) ordersTab.style.display = 'block'; else ordersTab.style.display = 'none';
            if (currentUser.showHistoryTab !== false) historyTab.style.display = 'block'; else historyTab.style.display = 'none';
            const invSearch = document.getElementById('inv-search-input');
            const invSort = document.getElementById('inv-sort-select');
            if (currentUser.enableInventorySearch === false) invSearch.style.display = 'none'; else invSearch.style.display = 'block';
            if (currentUser.enableInventorySort === false) invSort.style.display = 'none'; else invSort.style.display = 'block';
            if (currentUser.showLogoutButton !== false) document.getElementById('logout-trigger').style.display = 'block'; else document.getElementById('logout-trigger').style.display = 'none';

            const switchTabAutomatically = () => {
                const firstVisible = Array.from(document.querySelectorAll('.fb-tab-btn')).find(b => b.style.display !== 'none');
                if (firstVisible) { firstVisible.click(); }
            }

            let currentActiveTab = document.querySelector('.fb-tab-btn.active')?.dataset.tab;
            if (currentActiveTab === 'stock-pane' && currentUser.showStockTab === false) switchTabAutomatically();
            if (currentActiveTab === 'orders-pane' && currentUser.showOrdersTab === false) switchTabAutomatically();
            if (currentActiveTab === 'history-pane' && currentUser.showHistoryTab === false) switchTabAutomatically();
        };

        const showApp = () => {
            document.getElementById('auth-section').style.setProperty('display', 'none', 'important');
            document.getElementById('main-nav').style.display = 'flex';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-display-name').innerText = currentUser.name;

            updateUIVisibility();

            let savedTab = localStorage.getItem('fb_active_tab') || 'stock-pane';
            if (savedTab === 'stock-pane' && currentUser.showStockTab === false) savedTab = 'orders-pane';
            if (savedTab === 'orders-pane' && currentUser.showOrdersTab === false) savedTab = 'history-pane';
            if (savedTab === 'history-pane' && currentUser.showHistoryTab === false) savedTab = 'stock-pane';

            console.log(`[TAB RESTORE] Restoring tab: ${savedTab}`);
            document.querySelectorAll('.fb-tab-btn, .fb-pane').forEach(el => el.classList.remove('active'));
            const activeTabBtn = document.querySelector(`[data-tab="${savedTab}"]`);
            if (activeTabBtn) {
                activeTabBtn.classList.add('active');
                document.getElementById(savedTab)?.classList.add('active');
            } else {
                const firstVisible = Array.from(document.querySelectorAll('.fb-tab-btn')).find(b => b.style.display !== 'none');
                if (firstVisible) {
                    firstVisible.classList.add('active');
                    document.getElementById(firstVisible.dataset.tab)?.classList.add('active');
                    savedTab = firstVisible.dataset.tab;
                }
            }

            if (savedTab === 'stock-pane') loadInventory();
            else if (savedTab === 'orders-pane') loadOrders();
            else if (savedTab === 'history-pane') loadHistory();
        };

        const refreshSettings = async () => {
            if (!currentUser) return;
            console.log('[SETTINGS] Refreshing fresh settings from server...');
            try {
                const r = await fetch(`${PROXY_URL}?type=settings&_t=${Date.now()}`);
                const j = await r.json();
                if (j.data) {
                    currentUser = { ...currentUser, ...j.data };
                    console.log('[SETTINGS] Fresh settings merged:', j.data);
                    localStorage.setItem('fb_session_stable', JSON.stringify(currentUser));
                    updateUIVisibility();
                }
            } catch (e) {
                console.error('[SETTINGS] Failed to refresh settings:', e);
            }
        };

        const restoreSession = () => {
            const saved = localStorage.getItem('fb_session_stable');
            if (!saved) return;
            try {
                currentUser = JSON.parse(saved);
                showApp();
                refreshSettings();
            } catch (e) {
                console.error('Session restore error:', e);
                localStorage.removeItem('fb_session_stable');
            }
        };


        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(ok) {
            try { const o = audioCtx.createOscillator(); o.connect(audioCtx.destination); o.frequency.value = ok ? 800 : 200; o.start(); o.stop(audioCtx.currentTime + 0.1); } catch (e) { }
        }
        function vibrate(ok) { if (window.navigator && window.navigator.vibrate) { window.navigator.vibrate(ok ? 200 : [100, 50, 100]); } }

        document.getElementById('toggle-pass-btn').onclick = () => {
            const passInput = document.getElementById('staff-pass');
            const eyeOpen = document.getElementById('eye-open');
            const eyeClosed = document.getElementById('eye-closed');
            if (passInput.type === 'password') {
                passInput.type = 'text';
                eyeOpen.style.display = 'none';
                eyeClosed.style.display = 'block';
            } else {
                passInput.type = 'password';
                eyeOpen.style.display = 'block';
                eyeClosed.style.display = 'none';
            }
        };

        document.getElementById('login-btn').onclick = async () => {
            const id = document.getElementById('staff-id').value, pin = document.getElementById('staff-pass').value;
            if (!id || !pin) return;
            setLoader(true);
            try {
                const r = await fetch(`${PROXY_URL}?type=auth&identifier=${encodeURIComponent(id)}&pin=${pin}&_t=${Date.now()}`);
                const j = await r.json();
                if (j.data?.valid) {
                    currentUser = j.data.staff;
                    console.log('[LOGIN] Current user set to:', currentUser);
                    localStorage.setItem('fb_session_stable', JSON.stringify(currentUser));
                    showApp();
                }
                else alert("Invalid login");
            } catch (e) { alert("Error connecting to server"); }
            finally { setLoader(false); }
        }

        document.getElementById('logout-trigger').onclick = () => { localStorage.removeItem('fb_session_stable'); location.reload(); }

        document.querySelectorAll('.fb-tab-btn').forEach(btn => {
            btn.onclick = (e) => {
                const target = e.target.dataset.tab;
                document.querySelectorAll('.fb-tab-btn, .fb-pane').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(target).classList.add('active');

                // Save active tab to localStorage
                localStorage.setItem('fb_active_tab', target);

                // Only fetch if data is empty, otherwise just render existing data
                console.log(`[TAB SWITCH] Switching to: ${target}`);
                if (target === 'stock-pane') {
                    if (inventoryData.length > 0) {
                        console.log(`[STOCK] Using cached data (${inventoryData.length} items, page ${invPage})`);
                        renderInventory();
                    } else {
                        console.log('[STOCK] No cached data, fetching...');
                        loadInventory();
                    }
                } else if (target === 'orders-pane') {
                    if (ordersData.length > 0) {
                        console.log(`[ORDERS] Using cached data (${ordersData.length} items, page ${ordPage})`);
                        renderOrders();
                    } else {
                        console.log('[ORDERS] No cached data, fetching...');
                        loadOrders();
                    }
                } else if (target === 'history-pane') {
                    if (historyData.length > 0) {
                        console.log(`[HISTORY] Using cached data (${historyData.length} items, page ${histPage})`);
                        // Re-render history inline
                        document.getElementById('history-container').innerHTML = historyData.map((e, idx) => {
                            const hIdx = (histPage - 1) * 10 + idx + 1;
                            const fulfiller = e.log ? (e.log.scannedBy || e.log.staffEmail) : 'Unknown';
                            return `<div class="fb-order-card" style="padding:15px; border-radius:12px; border:1px solid var(--p-border);">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                    <div>
                                        <b style="font-size:14px;">${hIdx}. ORDER ${e.node.name}</b><br>
                                        <div style="margin-top:4px;">
                                            <span style="color:var(--p-success); font-weight:700; font-size:11px; letter-spacing:0.5px;">FULFILLED</span><br>
                                            <small style="color:var(--p-text-subdued)">Fulfilled by: <b>${fulfiller}</b></small>
                                        </div>
                                    </div>
                                    <div style="text-align:right;"><small style="color:var(--p-text-subdued); font-size:11px;">${new Date(e.node.updatedAt).toLocaleDateString()}</small></div>
                                </div>
                            </div>`;
                        }).join('');
                    } else {
                        console.log('[HISTORY] No cached data, fetching...');
                        loadHistory();
                    }
                }
            }
        });

        document.getElementById('inv-sort-select').onchange = (e) => {
            const [key, rev] = e.target.value.split(':');
            invSort = key; invReverse = (rev === 'true');
            invPage = 1; invStart = null; invEnd = null;
            loadInventory();
        };

        let searchTimeout;
        document.getElementById('inv-search-input').oninput = (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                invPage = 1; invStart = null; invEnd = null;
                loadInventory();
            }, 500);
        };

        const loadInventory = async (dir = 'next', isPagination = false) => {
            const q = document.getElementById('inv-search-input').value || '';
            console.log(`[STOCK FETCH] Direction: ${dir}, isPagination: ${isPagination}, Current page: ${invPage}, Query: ${q}`);
            setLoader(true);
            let cur = (dir === 'next') ? invEnd : invStart;
            if (!cur) dir = 'next';
            try {
                const r = await fetch(`${PROXY_URL}?type=inventory&direction=${dir}${cur ? `&cursor=${cur}` : ''}&sortKey=${invSort}&reverse=${invReverse}&query=${encodeURIComponent(q)}&_t=${Date.now()}`);
                const j = await r.json();
                inventoryData = j.data.edges;
                console.log(`[STOCK FETCH] Received ${inventoryData.length} items`);
                const pi = j.data.pageInfo;
                // Only update page counter when explicitly paginating, not on tab switches
                if (isPagination && cur) {
                    if (dir === 'next') invPage++;
                    else if (invPage > 1) invPage--;
                    console.log(`[STOCK FETCH] Page updated to: ${invPage}`);
                }
                invHasNext = pi.hasNextPage; invHasPrev = pi.hasPreviousPage;
                invStart = pi.startCursor; invEnd = pi.endCursor;
                document.getElementById('prev-inventory').disabled = !invHasPrev;
                document.getElementById('next-inventory').disabled = !invHasNext;
                document.getElementById('page-label-inventory').innerText = `Page ${invPage}`;
                document.getElementById('stock-pagination').style.display = (invHasNext || invHasPrev) ? 'flex' : 'none';
                renderInventory();
            } finally { setLoader(false); }
        }

        document.getElementById('prev-inventory').onclick = () => loadInventory('prev', true);
        document.getElementById('next-inventory').onclick = () => loadInventory('next', true);

        function renderInventory() {
            console.log(`[STOCK RENDER] Rendering ${inventoryData.length} items for page ${invPage}`);
            const container = document.getElementById('inventory-list');
            if (inventoryData.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--p-text-subdued)">No matching inventory found.</div>';
                return;
            }
            container.innerHTML = inventoryData.map((e, idx) => {
                const p = e.node, v = p.variants.edges[0].node;
                const bin = getBin(p);
                const displayNumber = (invPage - 1) * 10 + idx + 1;
                return `<div class="fb-stock-card">
                    <div class="fb-stock-body">
                        <img src="${p.featuredImage?.url || ''}" class="fb-stock-img">
                        <div class="fb-stock-info">
                            <div class="fb-stock-title">${p.title}</div>
                            <div class="fb-stock-sku">SKU: ${v.sku || 'N/A'}</div>
                            <div class="fb-stock-qty">Stock: ${p.totalInventory}</div>
                            <div class="fb-stock-meta">
                                <span class="fb-stock-bin">BIN: ${bin}</span>
                                <button class="fb-badge" style="cursor:pointer; background:var(--p-white); border:1px solid var(--p-border); color:var(--p-text-subdued); font-weight:700; margin:0; padding:2px 8px;" onclick="printTag('${p.title.replace(/'/g, "\\'")}', '${v.barcode}', '${bin}', '${p.featuredImage?.url}')">PRINT TAG</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        const loadOrders = async (dir = 'next', isPagination = false) => {
            console.log(`[ORDERS FETCH] Direction: ${dir}, isPagination: ${isPagination}, Current page: ${ordPage}`);
            setLoader(true);
            let cur = (dir === 'next') ? ordEnd : ordStart;
            if (!cur) dir = 'next';
            try {
                const r = await fetch(`${PROXY_URL}?type=orders&direction=${dir}${cur ? `&cursor=${cur}` : ''}&_t=${Date.now()}`);
                const j = await r.json();
                ordersData = j.data.edges;
                console.log(`[ORDERS FETCH] Received ${ordersData.length} items`);
                const pi = j.data.pageInfo;
                if (isPagination && cur) {
                    if (dir === 'next') ordPage++;
                    else if (ordPage > 1) ordPage--;
                    console.log(`[ORDERS FETCH] Page updated to: ${ordPage}`);
                }
                ordHasNext = pi.hasNextPage; ordHasPrev = pi.hasPreviousPage;
                ordStart = pi.startCursor; ordEnd = pi.endCursor;
                document.getElementById('prev-orders').disabled = !ordHasPrev;
                document.getElementById('next-orders').disabled = !ordHasNext;
                document.getElementById('page-label-orders').innerText = `Page ${ordPage}`;
                document.getElementById('orders-pagination').style.display = (ordHasNext || ordHasPrev) ? 'flex' : 'none';
                renderOrders();
            } finally { setLoader(false); }
        }

        document.getElementById('prev-orders').onclick = () => loadOrders('prev', true);
        document.getElementById('next-orders').onclick = () => loadOrders('next', true);

        function renderOrders() {
            console.log(`[ORDERS RENDER] Rendering ${ordersData.length} items for page ${ordPage}`);
            const container = document.getElementById('order-container');
            if (ordersData.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--p-text-subdued)">No pending swatch orders found.</div>';
                return;
            }
            container.innerHTML = ordersData.map((e, idx) => {
                const o = e.node;

                // Get all swatch items
                const allFabrics = o.lineItems.edges.filter(x => x.node.variant?.product?.productType?.toLowerCase() === 'swatch item');

                // Determine quantities
                let totalSwatchQty = 0;
                let fulfilledSwatchQty = 0;
                const unfulfilledLineItemIds = new Set();
                const fulfilledLineItemIds = new Set();

                allFabrics.forEach(fx => {
                    const q = fx.node.quantity;
                    const uq = fx.node.unfulfilledQuantity;
                    totalSwatchQty += q;
                    fulfilledSwatchQty += (q - uq);

                    if (uq > 0) unfulfilledLineItemIds.add(fx.node.id);
                    if (q - uq > 0) fulfilledLineItemIds.add(fx.node.id);
                });

                // Only count unfulfilled items for verification/button logic
                const fabrics = allFabrics.filter(fx => fx.node.unfulfilledQuantity > 0);

                if (allFabrics.length === 0) return '';
                const allVerified = fabrics.every(x => verifiedItems.has(x.node.id));
                const labelPrinted = printedLabels.has(o.id);
                const orderRowIdx = (ordPage - 1) * 10 + idx + 1;

                // Check if order is partially fulfilled
                const isPartiallyFulfilled = fulfilledSwatchQty > 0 && fulfilledSwatchQty < totalSwatchQty;
                const isPartiallyShippedStatus = fulfilledSwatchQty > 0;

                // Map line item IDs to fulfiller names from logs
                const fulfillerMap = {};
                if (e.logs && e.logs.length > 0) {
                    lastLog = e.logs[0]; // Most recent log
                    e.logs.forEach(log => {
                        const match = log.details.match(/\[ITEMS:([^\]]+)\]/);
                        if (match && match[1]) {
                            const itemIds = match[1].split(',');
                            itemIds.forEach(itemId => {
                                fulfillerMap[itemId] = log.scannedBy;
                            });
                        }
                    });
                }

                const fulfilledItems = allFabrics.filter(fx => fulfilledLineItemIds.has(fx.node.id));
                const unfulfilledItems = allFabrics.filter(fx => !fulfilledLineItemIds.has(fx.node.id));

                return `<div class="fb-order-card" ${isPartiallyShippedStatus ? 'style="border: 2px solid var(--p-accent);"' : ''}>
                    <div class="fb-order-header" onclick="toggleOrder(this)" ${isPartiallyShippedStatus ? 'style="background: rgba(187, 122, 126, 0.05);"' : ''}>
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <span>${orderRowIdx}. ORDER ${o.name} ${isPartiallyShippedStatus ? `<span style="background: var(--p-accent); color: white; padding: 2px 10px; border-radius: 20px; font-size: 11px; margin-left: 8px;">PARTIAL</span> <span style="font-size: 11px; color: var(--p-accent); margin-left:8px; font-weight:600;">(${fulfilledSwatchQty}/${totalSwatchQty} shipped)</span>` : ''}</span>
                            <svg class="fb-chevron ${idx === 0 ? 'open' : ''}" width="20" height="20" viewBox="0 0 20 20" fill="var(--p-text-subdued)"><path d="M5 7l5 5 5-5H5z"/></svg>
                        </div>
                    </div>
                    <div class="fb-order-items" ${idx === 0 ? 'style="display: block;"' : ''}>
                        ${allFabrics.map(fx => renderItemRow(fx, fulfilledLineItemIds.has(fx.node.id), fulfillerMap, o, verifiedItems, printedLabels, allVerified)).join('')}

                        ${allVerified ? `
                            <div style="padding:15px; text-align:center; background:#f9fafb; border-top: 1px solid #eee;">
                                ${!labelPrinted ?
                            `<button class="fb-btn fb-btn-secondary" style="width:100%; height:45px; font-size:15px;" onclick="printShippingLabel('${o.id}', '${o.name}', '${(o.shippingAddress?.name || "").replace(/'/g, "\\'")}', '${(o.shippingAddress?.address1 || "").replace(/'/g, "\\'")}, ${(o.shippingAddress?.city || "").replace(/'/g, "\\'")}', true)">Generate & Print Bulk Labels</button>` :
                            `<button class="fb-btn fb-btn-success" style="width:100%; height:45px; font-size:15px;" onclick="fulfillNow('${o.id}')">Fulfill Order ${o.name}</button>`
                        }
                            </div>
                        ` : (verifiedItems.size > 0 && fabrics.some(fx => verifiedItems.has(fx.node.id)) ? `
                            <div style="padding:15px; text-align:center; background:rgba(187, 122, 126, 0.03); border-top: 1px solid var(--p-border);">
                                <button class="fb-btn" style="width:100%; background: var(--p-accent);" onclick="fulfillNow('${o.id}', true)">Ship Verified Swatches (${fabrics.filter(fx => verifiedItems.has(fx.node.id)).length})</button>
                                <div style="margin-top: 8px; font-size: 11px; color: var(--p-accent); font-weight:500;">Only scanned items will be fulfilled.</div>
                            </div>
                        ` : '')}
                    </div>
                </div>`;
            }).join('');
        }

        function renderItemRow(fx, isFulfilled, fulfillerMap, o, verifiedItems, printedLabels, allVerified = false) {
            const bin = getBin(fx.node.variant?.product);
            const done = verifiedItems.has(fx.node.id);
            const fulfiller = fulfillerMap[fx.node.id] || 'admin';
            const sku = fx.node.variant?.sku || fx.node.variant?.product?.sku || 'N/A';

            return `<div class="fb-order-row" ${done ? 'style="background:rgba(72, 91, 89, 0.05)"' : (isFulfilled ? 'style="background:rgba(130, 115, 108, 0.02)"' : '')}>
                <img src="${fx.node.variant?.product?.featuredImage?.url}" width="40" style="border-radius:6px;">
                <div style="flex:1; overflow:hidden;">
                    <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px;">${fx.node.title}</div>
                    <div class="fb-item-info">
                        ${fx.node.unfulfilledQuantity === 0 ? `<span class="fb-status" style="color:var(--p-success) !important;">Status: fulfilled by ${fulfiller}</span> | ` : ''}
                        ${(fx.node.unfulfilledQuantity > 0 && fx.node.unfulfilledQuantity < fx.node.quantity) ? `<span class="fb-status" style="color:var(--p-accent) !important;">Partially shipped: ${fx.node.quantity - fx.node.unfulfilledQuantity}/${fx.node.quantity}</span> | ` : ''}
                        BIN: ${bin} | SKU: ${sku}
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    ${isFulfilled
                    ? `<div style="background:var(--p-success); color:#fff; padding:4px 12px; border-radius:20px; font-size:11px; font-weight:700; letter-spacing:0.5px;">FULFILLED</div>`
                    : (done
                        ? `<div style="background:rgba(72, 91, 89, 0.15); color:var(--p-success); padding:4px 12px; border-radius:20px; font-size:11px; font-weight:700; border:1px solid var(--p-success); letter-spacing:0.5px;">VERIFIED ✓</div>`
                        : `<button class="fb-btn" style="padding: 6px 15px; font-size: 12px; ${currentUser.enableScanButton === false ? 'pointer-events: none; opacity: 0.6;' : ''}" ${currentUser.enableScanButton === false ? 'disabled' : ''} onclick="startScan('${fx.node.id}', '${fx.node.variant?.barcode}', '${fx.node.title.replace(/'/g, "\\'")}', '${bin}', '${sku}')">SCAN</button>`
                    )
                }
                ${(done && !allVerified) ? `<button class="fb-badge" style="cursor:pointer; padding: 6px 10px;" onclick="printShippingLabel('${o.id}', '${o.name}', '${(o.shippingAddress?.name || "").replace(/'/g, "\\'")}', '${(o.shippingAddress?.address1 || "").replace(/'/g, "\\'")}, ${(o.shippingAddress?.city || "").replace(/'/g, "\\'")}')">PRINT</button>` : ''}
                </div >
            </div > `;
        }

        window.printShippingLabel = async (id, name, customer, address, isBulk = false) => {
            setLoader(true);
            const logo = currentUser?.brandLogo || '';
            var win = window.open('', '_blank', 'width=400,height=200'); // Smaller window for thermal label
            var s = '<script', se = '</' + 'script>';

            // Thermal Label Design (Small, Standard 1" x 2.625" size)
            var html = `< html ><head><title>Label - ${name}</title>
                <style>
                    body { font-family: sans-serif; margin: 0; padding: 5px; overflow: hidden; }
                    .label-container { display: flex; align-items: center; justify-content: flex-start; gap: 8px; height: 100%; }
                    .logo-box { width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
                    .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
                    .address-box { flex: 1; font-size: 10px; line-height: 1.2; overflow: hidden; }
                    .customer-name { font-weight: bold; font-size: 11px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                    @media print {
                        @page { size: 2.625in 1in; margin: 0; }
                        body { padding: 5px; }
                    }
                </style>
            </head><body>
                <div class="label-container">
                    <div class="logo-box">
                        ${logo ? `<img src="${logo}">` : '<div style="border: 1px solid #ddd; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">LOGO</div>'}
                    </div>
                    <div class="address-box">
                        <div class="customer-name">${customer || 'Customer'}</div>
                        <div style="word-wrap: break-word;">${address || 'Address Not Available'}</div>
                    </div>
                </div>
                ${s}>window.onload = function() { setTimeout(function() { window.print(); window.close(); }, 500); };${se}
            </body></html > `;

            win.document.open(); win.document.write(html); win.document.close();

            setTimeout(() => {
                setLoader(false);
                if (isBulk) {
                    printedLabels.add(id);
                    saveState();
                    renderOrders();
                }
            }, 1000);
        }

        const loadHistory = async (dir = 'next', isPagination = false) => {
            console.log(`[HISTORY FETCH]Direction: ${dir}, isPagination: ${isPagination}, Current page: ${histPage} `);
            setLoader(true);
            let cur = (dir === 'next') ? histEnd : histStart;
            if (!cur) dir = 'next';
            try {
                const r = await fetch(`${PROXY_URL}?type = fulfilled & direction=${dir}${cur ? `&cursor=${cur}` : ''}& _t=${Date.now()} `);
                const j = await r.json();
                historyData = j.data.edges;
                console.log(`[HISTORY FETCH] Received ${historyData.length} items`);
                const pi = j.data.pageInfo;
                if (isPagination && cur) {
                    if (dir === 'next') histPage++;
                    else if (histPage > 1) histPage--;
                    console.log(`[HISTORY FETCH] Page updated to: ${histPage} `);
                }
                histHasNext = pi.hasNextPage; histHasPrev = pi.hasPreviousPage;
                histStart = pi.startCursor; histEnd = pi.endCursor;
                document.getElementById('prev-history').disabled = !histHasPrev;
                document.getElementById('next-history').disabled = !histHasNext;
                document.getElementById('page-label-history').innerText = `Page ${histPage} `;
                document.getElementById('history-pagination').style.display = (histHasNext || histHasPrev) ? 'flex' : 'none';

                console.log(`[HISTORY RENDER] Rendering ${historyData.length} items for page ${histPage}`);
                const historyContainer = document.getElementById('history-container');
                if (historyData.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align:center; padding:40px; color:var(--p-text-subdued)">No fulfillment history found.</div>';
                } else {
                    historyContainer.innerHTML = historyData.map((e, idx) => {
                        const hIdx = (histPage - 1) * 10 + idx + 1;
                        const fulfiller = e.log ? (e.log.scannedBy || e.log.staffEmail) : 'Unknown';
                        return `< div class="fb-order-card" style = "padding:15px;" >
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <b>${hIdx}. ORDER ${e.node.name}</b><br>
                        <small style="color:var(--p-primary)">Status: FULFILLED</small><br>
                            <small style="color:var(--p-text-subdued)">Fulfilled by: <b>${fulfiller}</b></small>
                        </div>
                        <div style="text-align:right;"><small>${new Date(e.node.updatedAt).toLocaleString()}</small></div>
                </div>
            </div>`;
                    }).join('');
                }
            } finally { setLoader(false); }
        }

        document.getElementById('prev-history').onclick = () => loadHistory('prev', true);
        document.getElementById('next-history').onclick = () => loadHistory('next', true);

        window.startScan = (id, exp, title, bin, sku) => {
            if (isScanning) return;
            isScanning = true;
            document.getElementById('camera-modal').style.display = 'flex';
            document.getElementById('scan-target-name').innerText = title;
            document.getElementById('scan-target-sku').innerText = `SKU: ${sku} `;
            document.getElementById('scan-target-bin').innerText = `BIN #${bin} `;

            setTimeout(() => {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 20, qrbox: { width: 300, height: 150 }, aspectRatio: 1.0 },
                    async (decodedText) => {
                        if (isScanning) {
                            if (decodedText.trim() === exp.trim()) {
                                isScanning = false;
                                beep(true); vibrate(true);
                                verifiedItems.add(id);
                                saveState();
                                await closeScanner();
                                renderOrders();
                            } else {
                                isScanning = false;
                                beep(false); vibrate(false);
                                // Close scanner first, then show alert
                                await closeScanner();
                                alert(`WRONG ITEM!\nYou should go to BIN #${bin} \n\nRequired: ${exp} \nScanned: ${decodedText} \n\nClick OK to scan again.`);
                                // Restart scanning after user dismisses alert
                                startScan(id, exp, title, bin, sku);
                            }
                        }
                    },
                    () => { }
                ).catch(err => { console.error(err); alert("Camera failed."); closeScanner(); });
            }, 300);
        }

        window.closeScanner = async () => {
            isScanning = false;
            if (html5QrCode) {
                try { await html5QrCode.stop(); } catch (e) { }
                html5QrCode = null;
                const readerDiv = document.getElementById('reader');
                if (readerDiv) readerDiv.innerHTML = '';
            }
            document.getElementById('camera-modal').style.display = 'none';
            return true;
        }

        document.getElementById('scanner-cancel-btn').onclick = closeScanner;

        window.fulfillNow = async (id, isPartial = false) => {
            if (isPartial && !confirm("Are you sure you want to perform a partial fulfillment? Only scanned items will be shipped.")) return;

            setLoader(true);
            try {
                const orderNode = ordersData.find(e => e.node.id === id)?.node;
                const verifiedItemsForOrder = [];

                if (orderNode) {
                    orderNode.lineItems.edges.forEach(edge => {
                        if (verifiedItems.has(edge.node.id)) {
                            verifiedItemsForOrder.push({
                                id: edge.node.id,
                                quantity: edge.node.quantity
                            });
                        }
                    });
                }

                if (verifiedItemsForOrder.length === 0) {
                    alert("No verified items to fulfill.");
                    setLoader(false);
                    return;
                }

                const r = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: id,
                        staffData: currentUser,
                        verifiedItems: verifiedItemsForOrder
                    })
                });
                const res = await r.json();
                if (res.success) {
                    // Use detailed message from API if available, otherwise use generic message
                    const successMessage = res.message || (res.partiallyFulfilled ? "Partial Fulfillment Successful!" : "Order Fulfilled Successfully! Moving to History.");
                    alert(successMessage);

                    if (!res.partiallyFulfilled) {
                        printedLabels.delete(id);
                    }

                    if (orderNode) {
                        orderNode.lineItems.edges.forEach(edge => {
                            if (verifiedItems.has(edge.node.id)) {
                                verifiedItems.delete(edge.node.id);
                            }
                        });
                    }
                    saveState();
                    // Reset pagination to show newest data
                    ordPage = 1; ordStart = null; ordEnd = null;
                    histPage = 1; histStart = null; histEnd = null;

                    // Refresh after a short delay to let Shopify update its index
                    setLoader(true);
                    setTimeout(async () => {
                        await Promise.all([
                            loadOrders(),
                            loadHistory()
                        ]);
                        setLoader(false);
                    }, 2500);
                } else {
                    alert("Fulfillment Error: " + (res.error || "Unknown error"));
                    setLoader(false);
                }
            } catch (e) {
                console.error("Fulfillment Request Error:", e);
                alert("Request failed. Please check connection.");
                setLoader(false);
            }
            // We don't use finally { setLoader(false) } because loadOrders will handle it after the timeout
        }

        window.printTag = function (title, code, bin, img) {
            var win = window.open('', '_blank', 'width=600,height=800');
            var s = '<script', se = '</' + 'script>';
            var html = `< html ><head><title>Print Label</title>
                ${s} src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js">${se}
                <style>body{text-align:center;padding:40px;margin:0}img{width:300px;border-radius:12px;margin-bottom:15px}h1{font-size:36px;margin:10px 0}.bin{background:#000;color:#fff;font-size:50px;padding:15px;border-radius:8px;margin:20px 0}</style>
                </head><body>
                <img src="${img}" onerror="this.style.display='none'">
                <h1>${title}</h1>
                <div class="bin">BIN: ${bin}</div>
                <div style="margin-top:20px;"><svg id="barcode"></svg></div>
                ${s}>setTimeout(function(){if(window.JsBarcode){JsBarcode("#barcode","${code}",{width:4,height:120,displayValue:true,fontSize:24});setTimeout(function(){window.print()},300)}},500)${se}
                </body></html >`;
            win.document.open(); win.document.write(html); win.document.close();
        };

        // Check for old session and show warning
        const checkOldSession = () => {
            const saved = localStorage.getItem('fb_session_stable');
            if (saved) {
                document.getElementById('clear-session-btn').style.display = 'block';
                document.getElementById('session-warning').style.display = 'block';
            }
        };

        document.getElementById('clear-session-btn').onclick = () => {
            if (confirm('This will clear your old session. You will need to log in again with new credentials. Continue?')) {
                localStorage.removeItem('fb_session_stable');
                localStorage.removeItem(STORAGE_KEY_VERIFIED);
                localStorage.removeItem(STORAGE_KEY_PRINTED);
                alert('Session cleared! Please log in with your new credentials.');
                location.reload();
            }
        };

        checkOldSession();
        loadState();
        restoreSession();

        // Show the root once session state is determined
        const root = document.getElementById('fabric-scanner-root');
        if (root) {
            // If no user was restored, ensure auth section is visible
            if (!currentUser) {
                document.getElementById('auth-section').style.display = 'block';
            }
            root.classList.add('fb-ready');
        }
    })();
</script>
{% schema %}
{
"name": "Fabric Scanner",
"target": "section",
"settings": []
}
{% endschema %}